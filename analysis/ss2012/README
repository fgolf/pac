#################################################################
                    ss2012 Analysis 
#################################################################

Content:

1.  Overview 
2.  Create Babies 
3.  Create Yields/plots
4.  Create FakeRates 
5.  Create FlipRates (not yet)


#################################################################
                  1. Overview 
#################################################################

The analysis code makes a relatively flat baby TTree that can be used to do
simple studies, make yields and projection plots of variables. The analysis
uses ACLiC compiled macros to do the specific tasks on the babies such as
making the yield tables.

List of exectuables:
-----------------------------------------------------------------

- ss0212_analysis.exe:            Looper that produces the baby Trees (SS babies) from the
                                  cms2 ntuples.
- ss2012_merge_babies.exe:        Merge the SS babies and do an optional simple skim.
- ss2012_create_fakerate.exe:     Loop over fake rate babies and produce the fake
                                  rate needed for the fake prediction.
- ss2012_create_fakerate_eth.exe: Same as ss2012_create_fakerate.exe except attempts to make ETH's fakerate
- ss2012_outreach.exe:            Looper to create the outreach baby needed to do derive
                                  the outreach efficiency curves (TODO: use the SS babies
                                  for this as well).
- ss2012_outreach_closure.exe:    Looper to test the outreach curves.
- ss2012_plots.exe:               Looper on the SS babies to create the plots of the
                                  kinematic distribution used to make the yields and
                                  projection plots.
- ss2012_quick_check.exe:         Misc cms2 looper skeleton that can be used for misc quick studies. 
- ss2012_skim.exe:                Skimming code if we decide to produce SS skims

(we did this for ICHEP but not for HCP).

List of Macros (the important ones):
-----------------------------------------------------------------

- PrintYields.C:         Used to make the yield tables for the Analysis Note and also the projection Plots.
- OverlaySSPlots.C:      Used to overlay the kinematic plots generated by the
                         ss2012_plots.exe. For the projection plots, this does NOT do the error propogation on the fake/flip
                         prediction with the full propogation and only uses statical uncertainties + systematic uncertainties. 
                         It has been shown that the difference with using the full error propogration for the projections
                         has no visible difference and thus is neglected for simplicity of implementation.
                         The yield histograms (h_yield_ss) does have the full error propogation and is used for the yield tables.
- Outreach.C:            Create the outreach efficiency curves. 
- CreateHtVsMetPlot.C:   Create the 2-D HT vs MET scatter plot. (May move this to PlotLooper)
- CreateFakeRatePlots.C: Create the fake rate projection plots and tables for the Analysis Note.

The above are the main macros used for the analysis. The others are throw away
macros that are kept just in case they are useful again.

List of Scripts (the important ones):
-----------------------------------------------------------------

- merged_data.sh,      used to mearge the SS babies from data
- merged_mc.sh,        used to mearge the SS babies from mc
- run_all.sh:          run on the merged SS skims or cms2 ntuples for all the different datasets to make cms2 babies (mostly done on the grid now)
- ss2012_plot_all.sh:  plot the kinematic plots and make yield tables for all (or optionally one of) the signal regions 
- creage_fr.sh         generate the 2D fake rate histograms for both electrons and muons
- creage_fr_eth.sh     generate the 2D fake rate histograms for both electrons and muons from ETH's definition


#################################################################
                  2. Create Babies 
#################################################################

To make the SS babies, run the exectuable ss2012_analysis.exe

Example (run on data):

ss2012_analysis.exe --verbose 0 --sample data --output babies/data.root --run_list json/hcp_10p45fb_cms2.txt  --nev 1000 --njets 2"

Example (run on mc):

ss2012_analysis.exe --verbose 0 --sample ttw --output babies/ttw.root --nev 1000 --njets 2 \
 --input /hadoop/cms/store/group/snt/papers2012/Summer12_53X_MC/TTWJets_8TeV-madgraph_Summer12_DR53X-PU_S10_START53_V7A-v1/V05-03-13_slim/merged_ntuple.root"

To see the allow options:

ss2012_analysis.exe --help

Allowed options:
  --help                print this menu
  --nev arg             number of events to run on (-1 == all)
  --lumi arg            luminosity of analysis (1 fb^-1 default -- ignored for 
                        data)
  --verbose arg         output debug info
  --gen_only arg        only fill gen variables
  --sample arg          name of input sample (from at/Sample.h)
  --anal_type arg       name of input sample (from AnalysisType.h)
  --ntuple_type arg     ntuple type name (cms2, ss_skim, ...) (from 
                        at/Sample.h)
  --output arg          output ROOT file for baby tree (default: <sample 
                        name>.root)
  --input arg           input ntuple (default is determined by the sample used)
  --fr arg              fake rate file name (default: 
                        data/fake_rates/ssFR_data_standard_16Dec2012.root)
  --fl arg              flip rate file name (default: 
                        data/flip_rates/fliprate42X.root)
  --fr_hist arg         fake rate histogram name (default: h_mufr40c)
  --vtx_file arg        ROOT file for the vertex reweight (ignored for data)
  --run_list arg        Good Run list (no default)
  --sparms arg          unpack the sparms (default is false)
  --sync_print arg      print for sync exercise
  --njets arg           minimum # of jets to select
  --jetMetScale arg     +1 to scale jets up, -1 to scale jets down
  --isFastSim arg       use FastSim btag scale factors
  --apply_jec_otf arg   apply JEC on-the-fly using the specified global tag

#################################################################
                  5. Create Plots/Yields 
#################################################################

The way yields are generated is to run ss2012_plots.exe to create a ROOT file of histograms.
These histograms are defined in PlotLooper.cc.

For example:

ss2012_plots.exe --sample data --sr 0 --lumi 19.47 --output output/test.root --nev -1

Allowed options:
  --help                print this menu
  --nev arg             number of events to run on (-1 == all)
  --output arg          name of output root file (optional)
  --input arg           name of input root file (optional)
  --sample arg          name of input sample (from at/Sample.h)
  --anal_type arg       name of input sample (from at/AnalysisType.h)
  --fr_file arg         fake rate file name
  --fl_file arg         flip rate file name
  --vtx_file arg        ROOT file for the vertex reweight (ignored for data)
  --evt_list arg        name of file for event list.  empty for none
  --run_list arg        Good Run list (no default)
  --suffix arg          suffix to print (png, eps, pdf, all).  empty for none
  --nbtags arg          number of btags to cut on (default is 0)
  --njets arg           number of jets to cut on (default is 2)
  --sr arg              signal region number (default is 0)
  --do_sf arg           use the MC scale factors (default is true)
  --gr arg              for data, check the is_good_lumi() method
  --sparm0 arg          sparm0 value is required
  --sparm1 arg          sparm1 value is required
  --sparm2 arg          sparm2 value is required
  --sparm3 arg          sparm3 value is required
  --sf_flip arg         scale factor for flips (default is 0.8)
  --fr_unc arg          systematic uncertainty for fake prediction (default is 
                        0.5)
  --fl_unc arg          systematic uncertainty for flip prediction (default is 
                        0.2)
  --mc_unc arg          systematic uncertainty for MC prediction (default is 
                        0.5)
  --lumi arg            luminosity
  --charge arg          charge option (1 is ++ events, -1 is -- events, 0 is 
                        both)
  --excl arg            use exclusive signal region
  --l1_min_pt arg       trailing lepton min pT
  --l1_max_pt arg       trailing lepton max pT
  --l2_min_pt arg       leading lepton min pT
  --l2_max_pt arg       leading lepton max pT
  --ht arg              min HT
  --verbose arg         verbosity

Doing this for each sample can get tedious. A wrapper python script
(scripts/ss2012_plot_all.py) can be used to make plots for all of the data
and MC samples, produce plot overlays and yield tables. Also, if the option
sr -1 is given, the python script will make plots/yields for all the signal
regions and make a summary table (summary table for inclusive yields only at
this point).

Python was used for this because managing the various options was becoming combersome and
error prone -- python offers a simple options library.

The "out_name" field is the unique name for that set of plots/yields to keep
it distinct from other plots/yields you may want. This will store the plots in
the plots/<out_name> folder and the yields in the tables/<out_name> folder. The
default if none is given is test.

An example for inclusive SR 0:

./scripts/ss2012_plot_all.py --sr 0 --out_name=mytest --lumi=19.47

An example for all inclusive SR:

./scripts/ss2012_plot_all.py --sr -1 --out_name=mytest --lumi=19.47

An example for all exclusive SR:

./scripts/ss2012_plot_all.py --sr -1 --out_name=mytest --lumi=19.47

The fill list of options for this script are:

Usage: ss2012_plot_all.py [options]

Options:
  -h, --help            show this help message and exit
  --nev=NEV             The number of events to run (-1 for all)
  --lumi=LUMI           luminosity in fb^-1
  --suffix=SUFFIX       The suffix for the histograms (eps, png, pdf, all)
  --out_name=OUT_NAME   name for all the directories associated with these
                        yields
  --anal_type=ANAL_TYPE
                        analysis type
  --nbtags=NBTAGS       # btags
  --njets=NJETS         # jets
  --l1_min_pt=L1_MIN_PT
                        minimum pT on leading lepton
  --l1_max_pt=L1_MAX_PT
                        maximum pT on leading lepton
  --l2_min_pt=L2_MIN_PT
                        minimum pT on trailing lepton
  --l2_max_pt=L2_MAX_PT
                        maximum pT on trailing lepton
  --min_pt=MIN_HT       minimum HT
  --charge=CHARGE       charge of leptons (1 for +, -1 for -, 0)
  --sr=SR               signal region
  --test                test script -- print commands but do nothing
  --excl                use exclusive SR
  --incl                use incl SR (default)
  --no_hist             do not create histograms, do everything else
  --verbose             verbose print out


NOTE: the signal regions are steup for HCP at the moment -- to change in the
next weeks.

#################################################################
                  4. Create Fake Rates 
#################################################################

The fake rate babies are usually located at:

/nfs-7/userdata/rwkelley/babies/fr/<tag name>

and are set in fr::Sample.h ($PAC/packages/FakeRateBabyTools). When a new set of
FR babies is made, this needs to be updated.

To create a fake rate ROOT file that contains the fake rate 2D histograms for
both electron and muons, update the create_fr.sh script to point to the latest
tag and json file and run it.

cd $PAC/analysis/ss2012
./scripts/create_fr.sh

This script take no arguments.

Likewise, the create_fr_eth.sh is the same as the above script except it does
the ETH fake rate.

#################################################################
                  5. Create Flip Rate 
#################################################################

Not done here yet....
