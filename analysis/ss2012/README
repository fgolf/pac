#################################################################
                    ss2012 Analysis 
#################################################################

1.  Overview 
2.  Create Babies 
3.  Create FakeRates 
4.  Create FlipRates (not yet)
5.  Create Yields
6.  Create Projection Plots
7.  Code Organization


#################################################################
                  1. Overview 
#################################################################

The analysis code makdes a relatively flat baby TTree that can be used to do
simple studies, make yields and projection plots of variables. The analysis
uses ACLiC compiled macros to do the specific tasks on the babies such as
making the yield tables.

List of exectuables:
-----------------------------------------------------------------

- ss0212_analysis.exe:         Looper that produces the baby Trees (SS babies) from the
                               cms2 ntuples.
- ss2012_merge_babies.exe:     Merge the SS babies and do an optional simple skim.
- ss2012_create_fakerate.exe:  Loop over fake rate babies and produce the fake
                               rate needed for the fake prediction.
- ss2012_outreach.exe:         Looper to create the outreach baby needed to do derive
                               the outreach efficiency curves (TODO: use the SS babies
                               for this as well).
- ss2012_outreach_closure.exe: Looper to test the outreach curves.
- ss2012_plots.exe:            Looper on the SS babies to create the plots of the
                               kinematic distribution used to make the yields and
                               projection plots.
- ss2012_quick_check.exe:      Misc cms2 looper skeleton that can be used for misc quick studies. 
- ss2012_skim.exe:             Skimming code if we decide to produce SS skims

(we did this for ICHEP but not for HCP).

List of Macros (the important ones):
-----------------------------------------------------------------

- PrintYields.C:         Used to make the yield tables for the Analysis Note and also the projection Plots.
- OverlaySSPlots.C:      Used to overlay the kinematic plots generated by the
                         ss2012_plots.exe. This does NOT do the error propogation on the fake/flip
                         prediction properly and only uses statical uncertainties. This is intended for
                         quick studies when the full uncertainties are unecessary.
- Outreach.C:            Create the outreach efficiency curves. 
- CreateHtVsMetPlot.C:   Create the 2-D HT vs MET scatter plot. 
- CreateFakeRatePlots.C: Create the fake rate projection plots and tables for the Analysis Note.

The above are the main macros used for the analysis. The others are throw away
macros that are kept just in case they are useful again.

List of Scripts (the important ones):
-----------------------------------------------------------------

- merged_data.C,       merge_mc.C: used to mearge the SS babies
- merge_skims.C:       used to merge SS skims of the CMS2 ntuples 
- run_all.sh:          run on the merged SS skims or cms2 ntuples for all the different datasets to make cms2 babies (mostly done on the grid now)
- proj_yield_plots.sh: the different projections are currently implemented as "signal regions", this will generate all the histograms 
- plot_all.sh:         plot the kinematic plots and make yield tables for the data and all the MC backgrounds for a particular SR
- all_sr_plots.sh:     plot the kinematic plots and make yield tables for all the signal regions (basically, it calls plot_all.sh for all the SRs)
- creage_fr.sh         generate the 2D fake rate histograms for both electrons and muons


#################################################################
                  2. Create Babies 
#################################################################

To make the SS babies, run the exectuable ss2012_analysis.exe

Example (run on data):

ss2012_analysis.exe --verbose 0 --sample data --output babies/data.root --run_list json/hcp_10p45fb_cms2.txt  --nev 1000 --njets 2"

Example (run on mc):

ss2012_analysis.exe --verbose 0 --sample ttw --output babies/ttw.root --run_list json/hcp_10p45fb_cms2.txt  --nev 1000 --njets 2 --input /hadoop/cms/store/group/snt/papers2012/Summer12_53X_MC/TTWJets_8TeV-madgraph_Summer12_DR53X-PU_S10_START53_V7A-v1/V05-03-13_slim/merged_ntuple.root"

Allowed options:
  --help                print this menu
  --nev arg             number of events to run on (-1 == all)
  --lumi arg            luminosity of analysis (1 fb^-1 default -- ignored for 
                        data)
  --verbose arg         output debug info
  --gen_only arg        only fill gen variables
  --sample arg          name of input sample (from at/Sample.h)
  --anal_type arg       name of input sample (from at/AnalysisType.h)
  --ntuple_type arg     ntuple type name (cms2, ss_skim, ...) (from 
                        at/Sample.h)
  --output arg          output ROOT file for baby tree (<sample name>.root)
  --input arg           input ntuple (default for the sample in 
                        DataSetFactory.cpp)
  --fr arg              fake rate file name (default: 
                        data/fake_rates/ssFR_data_standard_24May2012.root)
  --fl arg              flip rate file name (default: 
                        data/flip_rates/fliprate42X.root)
  --fr_hist arg         fake rate histogram name (default: h_mufr40c)
  --vtx_file arg        ROOT file for the vertex reweight (ignored for data)
  --run_list arg        Good Run list (no default)
  --sparms arg          unpack the sparms (default is false)
  --sync_print arg      print for sync
  --njets arg           minimum # of jets to select
  --jetMetScale arg     +1 to scale jets up, -1 to scale jets down
  --isFastSim arg       use FastSim btag scale factors
  --apply_jec_otf arg   apply JEC on-the-fly using the specified global tag

#################################################################
                  3. Create Fake Rates 
#################################################################

The fake rate babies are usually located at:

/nfs-7/userdata/rwkelley/babies/fr/<tag name>

and are usually hard coded into ss2012_create_fakerate.exe. When a new set of
FR babies is made, this needs to be updated.

To create a fake rate ROOT file that contains the fake rate 2D histograms for
both electron and muons, update the create_fr.sh script to point to the latest
tag and json file and run it.

cd $PAC/analysis/ss2012
./scripts/create_fr.sh

This script take no agurments


#################################################################
                  4. Create Flip Rate 
#################################################################

Not done here yet....


#################################################################
                  5. Create Yields 
#################################################################

The scripts/all_sr_plots.sh creates the tables for all the signal regions. It takes 4 optional arguments

all_sr_plots.sh [lumi] [name] [nbtags] [charge_option]

- lumi:          luminosity to scale the MC prediction
- name:          unique name used to label yields/plots for all related folders and files
- nbtags:        the # of btags 
- charge_option: allowed values 0 (++/--), 1 (++), -1 (--)

Example:

cd $PAC/analysis/ss2012
./scripts/all_sr_plots.sh 10.45 hcp 2

This will generate 

1. raw histograms in the plots/<name>/srN where N is the signal regioin 0
2. a table of yields in text format in tables/yields_<name>_nbtags<nbtags>.txt
3. a summary table of yields for all the signal regions in text format in tables/yields_<name>_nbtags<nbtags>.txt
4. a table of yields in LatTex format in tables/<name> 

#################################################################
                  5. Projection plots 
#################################################################

The projection plots contain various distributions for the SS analysis that contain:

data yield
MC prediction
Fake prediction
Flip prediction

and it progogates the error and overlays an error hashed band.

To generate the projection plots, you must perform two steps

1.  make the raw histograms using the script proj_yield_plots.sh
2.  use the ROOT script PrintYields.C which contains a function CreateProjPlots

NOt finished....

To make projection plots use the PrintYields.C which contains a function:

void CreateProjPlots(const string& output_path = "", int charge_option = 0, const string& suffix = "png")

Ths can be used to create the projection plots for the analysis.  The currently implenented the plots are pt1, pt2, HT, MET, njets, nbtags.


